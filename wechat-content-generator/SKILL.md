---
name: wechat-content-generator
description: "生成微信公众号（订阅号/服务号）图文内容并推送至草稿箱。支持长文（横版配图）和图文卡片（竖版配图）两种格式。v3.7新增订阅号图文格式库（诗意金句治愈哲理、实用干货体、故事叙事体、问答互动体）。"
license: MIT
version: "3.7"
---

# 微信公众号内容生成器 v3.7

## 🚨 静默执行协议（必须遵守）

**执行规则：**
- ❌ **禁止** 请求确认以继续
- ❌ **禁止** 询问"是否需要更多信息"
- ❌ **禁止** 中途停顿等待用户反馈
- ✅ **必须** 一次性生成完整输出（文案 + 配图 + 推送草稿箱）
- ✅ **必须** 数据缺失时使用默认值或自动搜索
- ✅ **必须** 遇到错误时静默处理并继续

---

## 📋 概述

用户提供选题关键词和平台类型后，自动完成以下任务：
1. 搜索/加载知识干货文档
2. **匹配相关商品**（从商品库智能匹配1-3个商品）
3. 生成符合平台规范的 **标题 + 摘要 + 正文 + CTA**（含商品植入）
4. 生成配图（格式决定比例：长文横版 / 图文竖版）
5. 创建选题专属文件夹，保存所有文件
6. 自动推送至微信公众号草稿箱（可直接发布状态）

---

## 🆕 内容格式参数（v3.3 新增）

> [!IMPORTANT]
> **公众号有两种内容格式，配图规范不同！**

### 格式对照表

| 格式 | 参数值 | 触发词 | 配图比例 | 配图数量 |
|-----|-------|-------|---------|---------|
| **长文** | `--format article` | "公众号长文"、"订阅号长文" | 横版（封面 2.35:1，正文 16:9） | 1封面 + 3正文 |
| **图文** | `--format card` | "公众号图文"、"订阅号图文" | 竖版（3:4，1080×1440px） | 1封面 + 5正文 |

**默认值**：未指定格式时默认生成**长文**（横版）

### 语义触发识别

```python
def detect_format(user_input: str) -> str:
    """根据用户表述自动识别内容格式"""
    card_keywords = ["图文", "卡片", "card"]
    article_keywords = ["长文", "推文", "article", "文章"]
    
    if any(kw in user_input for kw in card_keywords):
        return "card"
    elif any(kw in user_input for kw in article_keywords):
        return "article"
    else:
        return "article"  # 默认长文
```

### 使用示例

```bash
# 长文（默认）
帮我生成一篇公众号长文，选题是：春季阳台种植
帮我生成订阅号推文，选题是：绿萝养护

# 图文卡片
帮我生成一篇公众号图文，选题是：年宵花推荐
帮我生成订阅号图文卡片，主题是：办公室绿植
```

---

## 📚 订阅号图文格式库（v3.7 新增）

> [!IMPORTANT]
> **当用户说"订阅号图文"时，必须先询问使用哪种格式！**

### 交互流程

**用户说：**
> "帮我写一篇订阅号图文，主题是：[主题]"

**必须回复：**
> "好的！请选择图文格式：
>
> 1️⃣ **诗意金句治愈哲理** - 现代小诗体，触动人心，适合展示美感和情感
> 2️⃣ **实用干货体** - 结构化知识点，清晰实用，适合教程和方法
> 3️⃣ **故事叙事体** - 情节化叙述，画面感强，适合经历和案例
> 4️⃣ **问答互动体** - 问答结构，对话感强，适合答疑和科普
>
> 请告诉我使用哪种格式？"

---

### 格式1：诗意金句治愈哲理

**特点：**
- 三段式现代小诗结构
- 每段2行，节奏感和留白明显
- 从具体场景升华到生活哲理
- 每句都有金句感，触动人心，可独立传播
- 用对比制造张力（城市vs家、你vs它）

**适用场景：**
- 展示植物美感、自然环境
- 传递生活态度和情感共鸣
- 治愈系、温暖调性的内容
- 配合精美图片的视觉呈现

**结构：**
```
标题（简洁有力）

第一段（2行）
具体场景 + 对比

第二段（2行）
互动关系 + 哲理

第三段（2行）
升华总结 + 情感
```

**示例：**
```markdown
# 与植物同居 🌿

城市再吵
家里有绿意就安静了

你养它
它也在养你

这是植物教会我的
关于生活的温柔 💚
```

---

### 格式2：实用干货体

**特点：**
- 结构化、清晰的知识点呈现
- 有小标题、要点列表、步骤说明
- 实操性强，可直接应用
- 逻辑清晰，易于理解和记忆

**适用场景：**
- 养护技巧、方法教程
- 问题诊断、解决方案
- 工具使用、操作指南
- 知识科普、原理解释

**结构：**
```
标题（明确主题）

引言（1-2句话说明重要性）

## 一、[知识点A]
✅ 要点1：具体说明
✅ 要点2：具体说明
⚠️ 注意：提醒事项

## 二、[知识点B]
📌 步骤1：...
📌 步骤2：...

## 三、总结
核心要点回顾
```

**示例：**
```markdown
# 春季浇水3大误区，90%的人都中招 💧

春天到了，很多植物因为浇水不当而出问题。

## 一、误区1：春天要多浇水 ❌
✅ **正确做法**：观察土壤干湿，见干见湿
✅ **判断方法**：手指插入土壤2-3cm，干了再浇
⚠️ **注意**：不同植物需水量不同

## 二、误区2：中午浇水最好 ❌
✅ **最佳时间**：早晨或傍晚
✅ **原因**：避免温差过大伤根

## 三、记住这3点
见干见湿、早晚浇水、因植而异 🌱
```

---

### 格式3：故事叙事体

**特点：**
- 有情节、有画面感的叙述
- 第一人称或第三人称视角
- 情感线索贯穿全文
- 真实感强，容易产生共鸣

**适用场景：**
- 养植经历、成长故事
- 用户案例、真实分享
- 季节变化、时间记录
- 情感类、治愈类内容

**结构：**
```
标题（带入感强）

开篇（设置场景和情绪）

发展（具体情节和细节）

转折/高潮（关键时刻）

结尾（感悟和升华）
```

**示例：**
```markdown
# 那盆差点被我养死的绿萝 🌿

去年春天，朋友送了我一盆绿萝。

我每天给它浇水，生怕它渴着。结果两周后，叶子开始发黄，根部也烂了。我以为它要死了。

后来才知道，我浇水太勤了。绿萝喜欢"见干见湿"，不是每天都要浇。

我开始学着观察它：土干了再浇，叶子蔫了再喷水。慢慢地，它长出了新叶，越来越茂盛。

现在它已经爬满了半面墙。每次看到它，我都会想起那个差点把它养死的自己。

养植物，就像照顾自己，需要耐心，也需要学会放手 💚
```

---

### 格式4：问答互动体

**特点：**
- 问题+回答的结构
- 模拟用户常见疑问
- 对话感强，亲切自然
- 信息密度高，易于查找

**适用场景：**
- 常见问题解答
- 知识科普、答疑解惑
- 产品使用、选购建议
- 快速获取信息的需求

**结构：**
```
标题（问题式）

引言（说明为什么要回答这些问题）

## Q1: [问题1]
A: [详细回答]
💡 小贴士：[补充说明]

## Q2: [问题2]
A: [详细回答]

## Q3: [问题3]
A: [详细回答]

总结（核心要点）
```

**示例：**
```markdown
# 绿萝养护5问5答 🌿

收到很多朋友关于绿萝的提问，今天统一回答。

## Q1: 绿萝多久浇一次水？
A: 没有固定时间，要看土壤干湿。春秋季一般3-5天一次，夏季2-3天，冬季7-10天。

💡 **判断方法**：手指插入土壤2-3cm，干了再浇。

## Q2: 叶子发黄是什么原因？
A: 主要有3个原因：
- 浇水过多导致烂根
- 光照不足或暴晒
- 缺少养分

💡 **解决方法**：先检查根部，再调整光照和施肥。

## Q3: 可以放在卧室吗？
A: 可以！绿萝能净化空气，晚上也不会释放太多二氧化碳。

## Q4: 怎么让它长得更茂盛？
A: 3个关键：
1. 明亮散射光
2. 见干见湿浇水
3. 春秋季每月施肥1次

## Q5: 黄叶要不要剪掉？
A: 要剪！黄叶会消耗养分，及时剪掉让植物集中精力长新叶。

记住这5点，你的绿萝一定能养好 💚
```

---

### 格式选择建议

| 内容类型 | 推荐格式 | 理由 |
|---------|---------|------|
| 展示植物美感 | 诗意金句治愈哲理 | 触动情感，配合图片效果最佳 |
| 养护教程 | 实用干货体 | 结构清晰，易于学习和实践 |
| 个人经历 | 故事叙事体 | 真实感强，容易产生共鸣 |
| 常见问题 | 问答互动体 | 信息密度高，快速解决疑问 |

---

## 🎯 双号运营策略核心（v3.0 新增）

### 订阅号 vs 服务号定位

| 维度 | 订阅号 | 服务号 |
|------|--------|--------|
| **定位** | 内容营销部门 | 会员服务部门 |
| **目标** | 获客、建立信任、品牌传播 | 转化、留存、复购、客服 |
| **推送频率** | 每天 1 次 | 每月 4 次 |
| **内容类型** | 场景痛点70% + 新手避坂20% + 季节时令10% | 会员日、新品上架、团购活动、积分提醒 |
| **CTA 方向** | 企业微信 + 服务号引导 | 商品卡片 + 小程序引导 |
| **商品植入** | 文末软推荐（0-1个） | 正文关联 + CTA卡片（1-3个） |

### 内容互补策略

| 场景 | 订阅号 | 服务号 |
|------|--------|--------|
| **新品上架** | 详细介绍文章（养护知识+场景搭配） | 简短推送（价格+优惠+购买链接） |
| **促销活动** | 不发（避免过度营销） | 推送（会员专享活动） |
| **养护知识** | 详细教程（场景化内容） | 不发（避免浪费推送机会） |
| **用户问题** | 写成文章（通用问题） | 客服回复（个性化问题） |

### 数据指标参考

| 指标 | 订阅号目标 | 服务号目标 |
|------|------------|------------|
| 阅读量 | 500+ | - |
| 阅读完成率 | 60%+ | - |
| 小程序点击率 | 10%+ | 30%+ |
| 服务号关注率 | 5%+ | - |
| 推送打开率 | - | 20%+ |
| 转化率 | - | 10%+ |

---

## 🔧 模块化执行模式 (v1.1 新增)

除完整流程外，支持**单独执行**以下模块：

### 模式一览

| 模式 | 触发词示例 | 说明 |
|------|-----------|------|
| `full` | "生成订阅号推文" | 完整流程（默认）|
| `text-only` | "重新生成文案" | 只重新生成文案，保留现有配图 |
| `image-only` | "为这篇文章生成配图" | 只生成配图，使用现有文案 |
| `single-image` | "重新生成第2张配图" | 重新生成指定的某一张图 |
| `cta-only` | "调整CTA" | 只修改CTA区块，正文不变 |
| `publish-only` | "推送到草稿箱" | 只执行推送，使用现有文件 |

---

### 模式1: 完整流程 (full)

**触发词：**
```
帮我生成一篇订阅号推文，选题是：春季阳台种植
```

**执行内容：** Step 1-7 全部执行

---

### 模式2: 仅重新生成文案 (text-only)

**场景：** 配图满意，但文案需要调整

**触发词：**
```
重新生成这篇推文的文案，配图不变
```
```
文案不太好，帮我重写，保留原来的图片
```

**执行内容：**
- ✅ 重新执行 Step 3（生成文案）
- ✅ 重新执行 Step 7（组装文档）
- ❌ 跳过 Step 5-6（不重新生成配图）
- 📌 使用已有文件夹中的配图

**注意：** 需提供现有文章路径或选题名称定位文件夹

---

### 模式3: 仅生成配图 (image-only)

**场景：** 已有文案，只需生成配图

**触发词：**
```
帮我为这篇文章生成配图
[粘贴文案或提供文件路径]
```
```
我有一篇现成的推文，帮我配图并推送
```

**执行内容：**
- ✅ 读取现有文案（从路径或直接输入）
- ✅ 执行 Step 4-6（选择风格 + 生成配图）
- ✅ 执行 Step 7（组装文档 + 推送）
- ❌ 跳过 Step 2-3（不生成文案）

---

### 模式4: 单张图片重新生成 (single-image)

**场景：** 某一张配图不满意，需要单独重新生成

**触发词：**
```
第2张配图不好看，帮我重新生成
```
```
封面图重新生成一下，风格改成 cozy-sketch
```
```
重新生成 01.png
```

**执行内容：**
- ✅ 定位指定图片（封面/01/02/03）
- ✅ 使用相同或指定的风格重新生成
- ✅ 覆盖保存到原位置
- ❌ 不影响其他图片和文案

**支持的图片标识：**
| 标识 | 文件名 | 说明 |
|------|--------|------|
| 封面/cover | cover.png | 封面图（2.35:1横版）|
| 第1张/01/配图1 | 01.png | 正文配图1（16:9横版）|
| 第2张/02/配图2 | 02.png | 正文配图2 |
| 第3张/03/配图3 | 03.png | 正文配图3 |

---

### 模式5: 仅调整CTA (cta-only)

**场景：** 正文内容满意，只需修改CTA部分

**触发词：**
```
帮我调整一下CTA，正文不变
```
```
把CTA改成服务号商品推荐模式
```
```
CTA里加上这个商品：营养土套装 ¥39.9
```

**执行内容：**
- ✅ 读取现有文档
- ✅ 保留标题、摘要、正文、配图
- ✅ 只替换CTA区块
- ✅ 重新保存文档

**CTA调整选项：**
- 切换平台类型（订阅号 ↔ 服务号）
- 更换CTA模板（参考 `knowledge/cta-templates.md`）
- 添加/更换商品信息（服务号）
- 修改引导文案

---

### 模式6: 仅推送草稿箱 (publish-only)

**场景：** 文案和配图都已就绪，只需推送

**触发词：**
```
把这篇文章推送到草稿箱
[提供文件夹路径]
```
```
推送 2026-01-13_春季阳台种植 到订阅号草稿箱
```
```
推送到服务号草稿箱
```

**执行内容：**
- ✅ 读取指定文件夹中的 Markdown + 配图
- ✅ 转换为微信兼容 HTML
- ✅ 上传图片到图床
- ✅ 内置推送功能
- ✅ 返回草稿箱链接和 Media ID
- ❌ 不修改任何本地文件

**平台选择：**
- **订阅号**：默认，使用 `SUBSCRIPTION_API_KEY`
- **服务号**：指定"服务号"关键词，使用 `SERVICE_API_KEY`

**独立执行说明：**
此模式可完全独立执行，只需提供：
1. 已生成的 Markdown 文件路径
2. 目标平台（订阅号/服务号）

内置推送功能会自动处理图片上传和格式转换。

---

### 模块化执行示例

#### 示例1：重新生成文案
```
用户：这篇文章的文案不太好，帮我重新生成
      路径：/发布记录/2026/订阅号/2026-01-13_春季阳台种植/

执行：
1. 读取该文件夹
2. 保留 cover.png, 01.png, 02.png, 03.png
3. 重新生成文案（基于相同选题）
4. 组装新的 Markdown 文档
5. 覆盖保存
```

#### 示例2：单张图片重生成
```
用户：第2张配图不好看，帮我换一个，风格保持 dreamy-photo

执行：
1. 定位 02.png
2. 读取原文案中第二段的内容
3. 使用 dreamy-photo 风格生成新图
4. 覆盖保存 02.png
```

#### 示例3：为现有文章配图并推送
```
用户：我已经写好了一篇推文，帮我配图并推送
      [粘贴文案内容]

执行：
1. 解析文案（提取标题、正文段落）
2. 判断选题类型 → 选择风格
3. 生成 4 张配图
4. 创建文件夹，保存文案 + 配图
5. 推送至草稿箱
```

#### 示例4：只调整CTA
```
用户：CTA改一下，加上这个商品：
      - 营养土3L装 ¥29.9
      - 小程序路径：pages/product/123

执行：
1. 读取现有文档
2. 保留 标题 + 摘要 + 正文 + 配图
3. 生成新的服务号CTA（包含商品卡片）
4. 替换原CTA区块
5. 保存文档
```

---

### ⚠️ 模块化执行注意事项

1. **需要定位现有文件**：除 `image-only`（可接受直接输入文案）外，其他模式需提供文件夹路径或选题名称
2. **自动检测模式**：根据用户表述自动判断执行模式，无需显式指定
3. **静默执行不变**：模块化执行同样遵守静默执行协议，不中途询问确认

---

## 🧹 文档格式清洗 (v1.1 新增)

当用户提供的文案不是标准发布格式时，**自动进行格式清洗**，确保最终推送的内容可直接发布。

### 自动清洗规则

#### 需要移除的内容
| 类型 | 示例 | 处理方式 |
|------|------|----------|
| **YAML Frontmatter** | `---\ntitle: xxx\n---` | 完全移除 |
| **元信息块** | `## 元信息`、`## Meta` | 移除整个区块 |
| **发布元信息** | `**发布平台：**`、`**发布时间：**`、`**选题类型：**`、`**目标人群：**` | 完全移除 |
| **文档统计信息** | `**本文字数：**`、`**阅读时间：**`、`**商品植入：**` | 完全移除 |
| **配图建议文字** | `【配图建议】阳光下的绿植...`、`配图描述：...` | 移除描述，保留图片占位 |
| **AI生成标记** | `[AI-IMAGE: ...]`、`<!-- AI建议 -->` | 移除标记 |
| **编辑注释** | `<!-- TODO: ... -->`、`// 待修改` | 移除注释 |
| **知识来源引用** | `[来源1]`、`参考文献：...` | 移除引用标记 |
| **字数统计** | `字数：1234`、`阅读时间：5分钟` | 移除 |
| **版本/修订信息** | `v1.2`、`最后修改：2026-01-13` | 移除 |
| **分割线过多** | 连续多个 `---` | 合并为一个 |
| **章节分隔标记** | `## 📝 标题`、`## 📄 摘要`、`## ✍️ 正文内容` | 移除（内容保留） |

#### 需要保留的内容
| 类型 | 说明 |
|------|------|
| **标题** | H1 标题（`# xxx`）|
| **摘要** | 引用块（`> xxx`）或第一段作为摘要 |
| **正文段落** | 所有正文内容 |
| **小标题** | H2/H3 标题（`## xxx`）|
| **列表** | 有序/无序列表 |
| **强调文字** | 加粗、斜体 |
| **emoji** | 保留所有 emoji |
| **图片标记** | `![](xxx.png)` 格式的图片引用 |
| **CTA区块** | 保留或按需重新生成 |

---

### 清洗流程

```
用户输入（非标准格式）
    ↓
[Step A] 内容解析
├─ 提取标题（H1 或首行）
├─ 提取摘要（引用块或自动从首段生成）
├─ 识别正文段落
└─ 识别图片占位符
    ↓
[Step B] 清洗移除
├─ 移除 YAML frontmatter
├─ 移除元信息区块
├─ 移除配图建议描述文字
├─ 移除 AI 标记和编辑注释
├─ 移除引用标记
└─ 清理多余空行和分割线
    ↓
[Step C] 格式规范化
├─ 标题限制 ≤25 字（超出自动精简）
├─ 摘要限制 ≤25 字（超出自动截断）
├─ 正文段落格式化
├─ 图片占位符标准化
└─ 添加标准组件（星标引导/互动引导）
    ↓
[Step D] 配图与推送
├─ 为图片占位符生成实际配图
├─ 组装完整文档
└─ 推送至草稿箱
    ↓
输出：可直接发布的推文
```

---

### 配图建议处理规则

用户输入的文案中可能包含**配图建议描述**，这些描述不应出现在最终推文中：

#### 常见配图建议格式（将被清洗）
```markdown
❌ 【配图建议】阳光透过窗户照在绿植上的温馨场景
❌ [配图：春天阳台种植场景]
❌ <!-- 这里放一张绿萝浇水的图 -->
❌ 配图描述：展示正确浇水方式的示意图
❌ 🖼️ 图片建议：...
❌ AI-IMAGE: A photograph of...
```

#### 清洗后的输出
```markdown
✅ ![配图1](01.png)
```

**处理逻辑：**
1. 检测配图建议描述文字
2. 提取配图的**位置信息**（第几张、对应哪段内容）
3. 提取配图的**风格提示**（如有）
4. 删除描述文字，替换为标准图片占位符
5. 用提取的提示生成实际配图

---

### 格式清洗示例

#### 输入（用户提供的草稿）
```markdown
---
title: 春季阳台种植指南
date: 2026-01-13
author: 小静
---

## 元信息
- 字数：1500
- 阅读时间：5分钟
- 配图数量：4张

# 春季阳台种植：新手必看的5个技巧 🌱

> 春天到了，阳台种植正当时。本文分享5个新手必知的种植技巧，让你的阳台变成小花园。

## 引言
春天是最适合种植的季节...

【配图建议】阳光明媚的阳台上摆满各种绿植的场景

## 一、选择合适的植物
根据阳台朝向选择植物...

[来源1] 《室内园艺指南》

<!-- TODO: 补充更多品种推荐 -->

【配图建议】不同朝向阳台适合的植物对比图

## 二、土壤和花盆
...正文内容...

---
---

## 参考文献
1. 《室内园艺指南》
2. 《阳台种植百科》
```

#### 输出（清洗后）
```markdown
<!-- 星标引导 -->
![星标引导](star_guide.png)

# 春季阳台种植：新手必看5技巧 🌱

> 春天到了，阳台种植正当时

---

## 引言
春天是最适合种植的季节... 🌿

![配图1](01.png)

## 一、选择合适的植物 🪴
根据阳台朝向选择植物...

![配图2](02.png)

## 二、土壤和花盆 ☀️
...正文内容...

---

<!-- CTA区块 -->
💡 **小贴士**：想了解更多植物养护技巧？
...

<!-- 互动引导 -->
![互动引导](interaction_guide.png)
```

---

### 清洗选项

用户可以通过表述控制清洗行为：

| 表述 | 行为 |
|------|------|
| "帮我清理格式并配图" | 执行完整清洗 + 配图 |
| "保留原有CTA" | 清洗时不替换CTA |
| "只清理格式，不改内容" | 只移除元信息，不修改正文 |
| "摘要我已经写好了，不要改" | 跳过摘要自动截断 |

## ⚙️ 配置信息

### API 配置
```
# 云雾 API（图片生成）
端点: https://yunwu.ai/v1
模型: gemini-3-pro-image-preview
API Key: sk-UqMsXIWjukWom3cHPkbf5xBqYrnEJHz3J7cdQQNhkFg974X5

# ImgBB 图床
获取地址: https://api.imgbb.com/

# 微绿流量宝（微信API）
端点: https://wx.limyai.com/api/openapi
```

> **🚫 严禁使用的工具/模型（会导致风格不一致）：**
> - ❌ **DALL-E 3** / `generate_image` 工具
> - ✅ **只能使用**：云雾 API（gemini-3-pro-image-preview）

### 路径配置
```
# 知识干货库（优先搜索）
知识库路径: /Users/dj/Documents/slowseasons AI工厂/内容生产/notebook lm干货稿/

# 输出根路径
订阅号: /Users/dj/Documents/slowseasons AI工厂/内容发布/发布记录/2026/订阅号/
服务号: /Users/dj/Documents/slowseasons AI工厂/内容发布/发布记录/2026/服务号/

# 公众号运营知识参考
Notes路径: /Users/dj/Desktop/小静的skills/notes/05-公众号/
```

### 图片尺寸
- **封面图**: 2.35:1 横版（900×383px，摘要配图）
- **正文配图**: 16:9 横版（900×506px 或 1080×607px）
- **配图数量**: 1封面 + 3正文图

> ⚠️ **注意**: 微信公众号正文配图应使用横版，与小红书的 3:4 竖版不同。

---

## 📁 文件输出结构

> **📌 文件命名规范（v3.4 新增）**
> - 发布文案：`【发布】日期_选题名.md` - 用于发布到公众号
> - 说明文档：`生成结果.md` - 记录生成过程和结果（可选查看）

### 订阅号输出
```
/内容发布/发布记录/2026/订阅号/
└── 2026-01-13_春季阳台种植/
    ├── 【发布】2026-01-13_春季阳台种植.md  # 发布文案（用这个）
    ├── 生成结果.md                         # 生成说明（可选）
    ├── cover.png                            # 封面图（摘要用）
    ├── 01.png                               # 正文配图1
    ├── 02.png                               # 正文配图2
    └── 03.png                               # 正文配图3
```

### 服务号输出
```
/内容发布/发布记录/2026/服务号/
└── 2026-01-13_春季播种工具/
    ├── 【发布】2026-01-13_春季播种工具.md  # 发布文案（用这个）
    ├── 生成结果.md                         # 生成说明（可选）
    ├── cover.png                            # 封面图
    ├── 01.png                               # 正文配图1
    ├── 02.png                               # 正文配图2
    └── product_01.png                       # 商品配图（可选）
```

---

## 🔄 执行流程

### Step 0: 时间信息查询与验证（v3.6 新增）⏰

**强制规则：涉及时间点的内容，必须先查询再写入文案**

#### 查询流程

```bash
# 1. 查询当前日期
date +%Y-%m-%d

# 2. 查询目标日期（如春节、节气等）
# 使用 WebSearch 或 WebFetch 查询准确日期
```

#### 常见时间点查询

| 时间点类型 | 查询方法 | 示例 |
|-----------|---------|------|
| **节日** | WebSearch查询具体年份的日期 | "2026年春节日期"、"2026 Chinese New Year date" |
| **节气** | WebSearch查询节气时间表 | "2026年立春时间"、"2026 solar terms" |
| **倒计时** | 先查询目标日期，再计算天数差 | 今天2026-01-19，春节2026-02-17，差29天 |
| **相对时间** | 基于当前日期计算 | "本周末"、"下个月" |

#### 时间计算示例

```python
from datetime import datetime

# 查询当前日期
today = datetime.now()
print(f"今天: {today.strftime('%Y-%m-%d')}")

# 查询目标日期（需先通过WebSearch获取）
target_date = datetime(2026, 2, 17)  # 2026年春节

# 计算天数差
days_diff = (target_date - today).days
print(f"距离春节还有 {days_diff} 天")
```

#### 错误示例 vs 正确示例

❌ **错误做法**：
```markdown
> 距离春节还有10天，选对年宵花迎好运
```
（未查询，凭感觉写，导致错误）

✅ **正确做法**：
```bash
# Step 1: 查询当前日期
$ date +%Y-%m-%d
2026-01-19

# Step 2: 查询春节日期
$ WebSearch "2026年春节日期"
结果: 2026年2月17日

# Step 3: 计算天数
29天 = 2026-02-17 - 2026-01-19

# Step 4: 写入文案
> 距离春节还有29天，选对年宵花迎好运
```

#### 适用场景

- 摘要中的倒计时（"距离XX还有N天"）
- 正文中的时间节点（"本周末"、"下个月初"）
- 季节性内容（"现在正值XX季节"）
- 节气相关（"立春后的养护"）

**⚠️ 核心原则：永远不要假设或猜测时间信息，必须查询验证！**

---

### Step 1: 解析输入与细化选题
- 解析选题关键词和平台类型（subscription / service）
- 若选题模糊（如"关于春天"），自动细化为具体主题
- 确定输出文件夹路径：`日期_选题名/`
- **判断当天日期类型**（工作日/周末），准备发布时间建议

### Step 2: 搜索/加载知识干货
**优先级搜索顺序：**
1. **本地干货库**：`/notebook lm干货稿/` 目录
   - 匹配规则：文件名包含选题关键词
   - 如：选题"阳台种植" → 匹配 `阳台春季种植规划与实操全书.md`
2. **无匹配则网络搜索**：调用 web-resource-search 获取可靠知识
   - 优先学术文献、权威机构来源
   - 搜索结果保存至干货库

**干货文档格式（6模块结构）：**
- 模块 A：定义与分类
- 模块 B：硬核参数矩阵
- 模块 C：因果逻辑链
- 模块 D：常见误区矫正
- 模块 E：场景变量影响
- 模块 F：实操执行手册

### Step 2.5: 商品库匹配（v2.0 新增）🛒

**调用 product-catalog 技能匹配商品：**

```python
import pandas as pd

# 商品库路径
PRODUCT_EXCEL = "/Users/dj/Documents/slowseasons AI工厂/商品库/商品数据.xlsx"

def match_products(keywords, max_results=3):
    df = pd.read_excel(PRODUCT_EXCEL)
    df = df[df['商品状态'] == '销售中']
    
    scored = []
    for _, row in df.iterrows():
        score = 0
        text = f"{row['商品名称']} {row['商品分组']} {row['商品卖点']}"
        for kw in keywords:
            if kw in text:
                score += 1
                if kw in str(row['商品名称']):
                    score += 2
        if score > 0:
            scored.append((score, row))
    
    scored.sort(key=lambda x: x[0], reverse=True)
    return [s[1] for s in scored[:max_results]]

# 使用示例
keywords = ["绿植", "营养土", "花盆"]  # 根据选题自动提取
matched = match_products(keywords)
```

**匹配规则（v3.4 更新）：**
| 平台类型 | 商品数量 | 植入方式 | 价格展示 |
|----------|----------|----------|----------|
| 订阅号 | 0-1个 | 文末软推荐 | ❌ 正文及推荐严禁出现价格 |
| 服务号 | 1-3个 | 正文关联 + CTA卡片 | ❌ 正文严禁价格，仅在CTA卡片允许 |

**⚠️ 重要：严禁在正文中使用具体金额（如"¥29.9"），请用"性价比高"、"实惠"代替。**

### Step 3: 生成文案
参考知识库 `knowledge/subscription-copywriting.md` 和 `knowledge/wechat-operation-tips.md`

**字数限制（严格遵守）：**
| 元素 | 限制 | 说明 |
|------|------|------|
| 标题 | ≤25字 | 含标点和emoji |
| 摘要 | ≤25字 | **必须生成**，转发时显示完整 |
| 正文 | 800-2000字 | 结构化段落 |

**⚠️ 摘要生成规则（v3.5 新增 - 必须遵守）：**
- **必须为每篇文章生成摘要**，不能省略
- 摘要格式：`> 摘要内容`（引用块格式）
- 摘要位置：标题之后，第一个分隔线之前
- 摘要内容要求：
  - ✅ 概括文章核心价值（如"5种年宵花选购养护全攻略"）
  - ✅ 包含时效性或紧迫感（如"距离春节30天"）
  - ✅ 吸引读者点击（如"教你选对年宵花养到正月十五"）
  - ❌ 避免空洞表述（如"本文介绍了..."）
  - ❌ 避免重复标题内容

**订阅号文案规则（v3.0 更新）：**
- 开头：星标引导 + 引言（共鸣式/问题式）
- 正文：知识性内容，分点呈现，每段2-3个emoji
- **⚠️ 必须嵌入配图引用**：正文中必须包含 `![配图1](01.png)` 等图片引用
- 结尾：CTA（企业微信二维码 + 互动引导）
- 调性：专业但亲切，慢养四季品牌风格
- **内容配比**：场景痛点类70% + 新手避坂20% + 季节时令10%

**🚫 格式禁令（v3.5 - 纯净输出）：**
- **严禁生成任何元信息列表**（如：`**发布平台：**`、`**字数：**`、`**发布时间：**`）。
- **严禁使用显式分节标题**（如：`## 标题`、`## 摘要`、`## 正文`），直接输出内容即可。
- 确保输出的 Markdown/HTML 干净无杂质，可直接推送到草稿箱。

**🚫 价格禁令（v3.4）：**
- 正文及任何部分**严禁出现具体价格**（如"只要9.9元"）。
- 价格具有时效性和浮动性，文案应关注价值而非金额。

**👤 人设安全原则（v3.4 核心）：**
- ❌ **严禁臆造身份**：除非用户明确提示，否则禁止假设用户是"租房党"、"北漂"。
- ✅ **中性化叙述**：使用"对于居住空间有限的朋友"代替"对于我们租房党"。
- ✅ **客观化建议**：使用"很多人会遇到..."代替"我搬家时发现..."。

**服务号文案规则（v3.0 更新）：**
- 同上，但正文需自然关联商品
- CTA：商品推荐卡片（1-3个商品）
- 调性：导购但不硬推
- **每月推送分配**：
  - 第1次（1号）：会员日活动
  - 第2次（10号）：新品上架/团购预售
  - 第3次（20号）：团购活动
  - 第4次（月底）：会员权益/积分提醒

### Step 4-5: 选择风格 & 生成配图 Prompt

> [!IMPORTANT]
> **配图规范根据内容格式不同！**

#### 📐 格式决定配图规范

```python
def get_image_config(content_format: str) -> dict:
    """根据内容格式返回配图配置"""
    if content_format == "card":
        # 图文卡片：竖版 3:4（与小红书相同）
        return {
            "guide": "xiaohongshu-content-generator/knowledge/image-prompt-guide.md",
            "cover_ratio": "3:4",
            "content_ratio": "3:4",
            "cover_size": "1080×1440px",
            "content_size": "1080×1440px",
            "image_count": "1封面 + 5正文"
        }
    else:
        # 长文（默认）：横版
        return {
            "guide": "wechat-content-generator/knowledge/wechat-image-prompt-guide.md",
            "cover_ratio": "2.35:1",
            "content_ratio": "16:9",
            "cover_size": "900×383px",
            "content_size": "900×506px",
            "image_count": "1封面 + 3正文"
        }
```

#### 长文格式（article）配图规范

> **📚 使用**：[wechat-image-prompt-guide.md](file:///Users/dj/Desktop/%E5%B0%8F%E9%9D%99%E7%9A%84skills/wechat-content-generator/knowledge/wechat-image-prompt-guide.md)

| 图片类型 | 比例 | Prompt 开头 |
|---------|------|------------|
| 封面图 | 2.35:1 | `A 2.35:1 wide banner...` |
| 正文配图 | 16:9 | `A 16:9 wide...` |

#### 图文格式（card）配图规范

> **📚 使用**：[image-prompt-guide.md](file:///Users/dj/Desktop/%E5%B0%8F%E9%9D%99%E7%9A%84skills/xiaohongshu-content-generator/knowledge/image-prompt-guide.md)（与小红书相同）

| 图片类型 | 比例 | Prompt 开头 |
|---------|------|------------|
| 封面图 | 3:4 | `A 3:4 photograph...` |
| 正文配图 | 3:4 | `A 3:4 illustration...` |

#### 风格速查表（两种格式通用）

| 选题类型 | 风格 | 说明 |
|---------|------|------|
| 场景/养护类（居家、浇水、光照） | `dreamy-photo` | 真实感、自然光、柔焦 |
| 教程类（方法、步骤、技巧） | `cozy-sketch` | 手绘涂鸦感、可配中文标注 |
| 科普/诊断类（知识、黄叶、病虫害） | `infographic-sketch` | 信息图+手绘、清晰层级 |
| 情感/季节类（心情、春播、年宵花） | `soft-botanical` | 柔和水彩、氛围感 |
| 产品/推荐类（好物、工具、测评） | `minimal-collage` | 极简拼贴、突出主体 |

#### ⚠️ 关键规则
1. **同一选题的配图必须使用相同风格**
2. **根据格式选择正确的配图规范文档**
3. **生成前必须检查**：Prompt 比例与格式匹配
4. **🔴 图片文字必须全部使用中文**（v3.4 新增）
   - 在 Prompt 中明确要求：`CRITICAL: Use ONLY Chinese characters for all text. NO English letters. NO English words.`
   - 所有标注、说明、标签必须是中文
   - 禁止出现任何英文字母

#### 🚨 核心原则：基于文案内容生成 Prompt（v3.1 新增）

**每张配图的 Prompt 必须从对应段落内容中提取视觉元素：**

```
文案结构               →  配图分配
──────────────────────────────────────
引言                   →  封面图（选题核心画面）
第1个知识点            →  配图1（该知识点的视觉呈现）
第2个知识点            →  配图2（该知识点的视觉呈现）
第3个知识点            →  配图3（该知识点的视觉呈现）
```

**❌ 禁止**：使用通用 Prompt 模板批量生成所有图片
**✅ 必须**：为每张图从对应段落提取主体、场景、特征后生成专属 Prompt

---

#### 配图模板与尺寸规范

> **📌 详细模板请查阅**：[wechat-image-prompt-guide.md](file:///Users/dj/Desktop/%E5%B0%8F%E9%9D%99%E7%9A%84skills/wechat-content-generator/knowledge/wechat-image-prompt-guide.md)

**尺寸速查表：**

| 图片类型 | 比例 | 尺寸 | Prompt 开头 |
|----------|------|------|-------------|
| 封面图 | 2.35:1 | 900×383px | `A 2.35:1 wide banner...` |
| 正文配图 | 16:9 | 900×506px | `A 16:9 wide...` |

> [!WARNING]
> **❌ 禁止使用小红书的 `3:4` 或 `--ar 3:4`**
> **✅ 必须使用横版比例：`2.35:1 wide banner` 或 `16:9 wide`**

### Step 6: 调用云雾 API 生成图片

**⚠️ 必须使用云雾 API，不要使用内置的 generate_image 工具**

#### Python 调用代码
```python
import requests
import base64
import os
import re

def generate_image_yunwu(prompt: str, output_path: str):
    """
    使用云雾 API (Chat Completions) 生成图片
    """
    url = "https://yunwu.ai/v1/chat/completions"
    
    headers = {
        "Authorization": "Bearer sk-UqMsXIWjukWom3cHPkbf5xBqYrnEJHz3J7cdQQNhkFg974X5",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": "gemini-3-pro-image-preview",
        "messages": [
            {"role": "user", "content": f"Generate an image: {prompt}"}
        ]
    }
    
    try:
        response = requests.post(url, headers=headers, json=payload, timeout=120)
        response.raise_for_status()
        
        result = response.json()
        content = result["choices"][0]["message"]["content"]
        
        # 提取 Base64 数据
        match = re.search(r"data:image/\w+;base64,([^)]+)", content)
        if not match:
            print("❌ 未能在响应中找到图片数据")
            return False
            
        image_data = match.group(1)
        
        # 保存图片
        os.makedirs(os.path.dirname(output_path), exist_ok=True)
        with open(output_path, "wb") as f:
            f.write(base64.b64decode(image_data))
        
        print(f"✅ 图片已保存: {output_path}")
        return True
        
    except Exception as e:
        print(f"❌ 图片生成失败: {e}")
        return False
```

### Step 7: 组装Markdown文档并推送

> **⚠️ 图文格式必须进行格式清洗！**

**Step 7a: 格式清洗（图文格式必须执行）**

对于图文卡片格式（card），发布文档必须清洗为纯文本格式，可直接复制粘贴到公众号编辑器：

```python
def clean_format_for_card(content: str) -> str:
    """
    清洗图文格式的Markdown，转换为纯文本
    """
    import re

    cleaned = content

    # 移除标题符号（# ## ###）但保留文字
    cleaned = re.sub(r'^#{1,6}\s+', '', cleaned, flags=re.MULTILINE)

    # 移除引用符号（>）但保留文字
    cleaned = re.sub(r'^>\s+', '', cleaned, flags=re.MULTILINE)

    # 移除分隔线
    cleaned = re.sub(r'^---+\s*$', '', cleaned, flags=re.MULTILINE)

    # 移除加粗符号（**）但保留文字
    cleaned = re.sub(r'\*\*([^*]+)\*\*', r'\1', cleaned)

    # 移除图片引用，替换为[图片]标记
    cleaned = re.sub(r'!\[配图\d+\]\([^)]+\)', '[图片]', cleaned)

    # 清理多余空行
    cleaned = re.sub(r'\n{3,}', '\n\n', cleaned)

    # 去掉开头和结尾的空行
    cleaned = cleaned.strip()

    return cleaned

# 使用示例
if content_format == "card":
    markdown_content = clean_format_for_card(markdown_content)
```

**清洗规则**：
- ✅ 移除所有Markdown格式符号（#, >, **, ---, 等）
- ✅ 保留文字内容和emoji
- ✅ 图片位置用[图片]标记替代
- ✅ 保持段落结构和换行

**Step 7b: 推送前清洗验证（强制）**

**Step 7b: 推送前清洗验证（强制）**

```python
def verify_clean_content(content: str) -> tuple[bool, list]:
    """
    验证内容是否已清洗干净
    返回: (是否干净, 发现的问题列表)
    """
    problems = []

    # 检查元信息
    meta_patterns = [
        "**发布平台：**", "**发布时间：**", "**选题类型：**",
        "**目标人群：**", "**本文字数：**", "**阅读时间：**",
        "**商品植入：**", "## 📝 标题", "## 📄 摘要",
        "## ✍️ 正文内容"
    ]

    for pattern in meta_patterns:
        if pattern in content:
            problems.append(f"发现未清理的元信息: {pattern}")

    return len(problems) == 0, problems

# 使用示例
is_clean, issues = verify_clean_content(markdown_content)
if not is_clean:
    print("❌ 文档包含未清理的元信息，正在自动清洗...")
    markdown_content = clean_content(markdown_content)  # 执行清洗
```

**❌ 如果验证失败，必须先执行清洗再推送！**

---

**Step 7c: 组装顺序**
1. 星标引导图片组件（顶部）
2. 标题（H1）
3. 摘要（引用块）
4. 正文（配图内嵌于段落间）
5. CTA区块（订阅号/服务号差异化）
6. 互动引导图片组件（底部）

**Step 7d: 推送至草稿箱（必须执行命令）**

> **🚨 必须执行以下命令完成推送，不能只"准备推送"！**

**推送流程：**
- 自动检测文档格式和图片引用
- 上传图片到图床并替换链接
- 生成微信兼容的HTML格式
- 推送至公众号草稿箱

**验证推送成功：**
- 日志显示 `✓ 推送成功` 和 Media ID
- 公众号后台可查看草稿箱中的文章
- 图片正确显示，格式无问题

**Step 7d: 推送验证（v3.2 新增）⚠️**

> **必须验证推送结果，确保草稿箱成功创建！**

```python
def verify_push_result(push_result: dict, output_folder: str) -> bool:
    """
    验证草稿箱推送是否成功
    
    检查项：
    1. API 返回是否成功
    2. media_id 是否有效
    3. 推送结果.json 是否正确保存
    """
    import os
    import json
    
    # 检查返回结果
    if not push_result:
        print("❌ 推送失败：API 无返回")
        return False
    
    if push_result.get('errcode', 0) != 0:
        print(f"❌ 推送失败：{push_result.get('errmsg', '未知错误')}")
        return False
    
    media_id = push_result.get('media_id')
    if not media_id:
        print("❌ 推送失败：未返回 media_id")
        return False
    
    # 保存推送结果
    result_path = os.path.join(output_folder, "推送结果.json")
    with open(result_path, 'w', encoding='utf-8') as f:
        json.dump({
            "status": "success",
            "media_id": media_id,
            "push_time": datetime.now().isoformat(),
            "draft_url": f"https://mp.weixin.qq.com/cgi-bin/appmsg?action=list&type=10"
        }, f, ensure_ascii=False, indent=2)
    
    print(f"✅ 推送成功！media_id: {media_id}")
    print(f"📁 结果已保存: {result_path}")
    return True

def retry_push(content_data: dict, max_retries: int = 3) -> dict:
    """
    推送失败时自动重试
    """
    for attempt in range(max_retries):
        try:
            result = wechat_publish(content_data)
            if result.get('errcode', 0) == 0:
                return result
            print(f"⚠️ 第 {attempt + 1} 次推送失败，重试中...")
        except Exception as e:
            print(f"⚠️ 推送异常: {e}")
        
        time.sleep(5)  # 等待5秒后重试
    
    return {"errcode": -1, "errmsg": "重试3次后仍然失败"}
```

**推送验证检查清单：**
- [ ] API 返回 errcode 是否为 0？
- [ ] 是否成功获取 media_id？
- [ ] 推送结果.json 是否已保存？
- [ ] 如果失败，是否已记录错误原因？

---

### Step 8: 生成发布时间建议（v3.4 新增）

根据当天日期自动推荐最佳发布时间，并写入生成结果文档。

```python
from datetime import datetime

def get_publish_time_recommendation(content_type: str) -> dict:
    """
    根据当天日期和内容类型推荐发布时间

    Args:
        content_type: 内容类型（实用干货/知识科普/治愈故事等）

    Returns:
        {
            "date_type": "工作日" | "周末",
            "best_time": "最佳时间",
            "alternative_time": "次选时间",
            "reason": "推荐理由"
        }
    """
    today = datetime.now()
    weekday = today.weekday()  # 0=周一, 6=周日

    # 判断是否为周末
    is_weekend = weekday >= 5

    if is_weekend:
        # 周末推荐
        recommendations = {
            "实用干货": {
                "best_time": "10:00-11:00",
                "alternative_time": "14:00-16:00",
                "reason": "周末用户睡懒觉后的早午茶时间，心情放松，阅读意愿强"
            },
            "知识科普": {
                "best_time": "14:00-16:00",
                "alternative_time": "20:00-21:30",
                "reason": "下午茶时间，适合深度阅读和学习"
            },
            "治愈故事": {
                "best_time": "20:00-21:30",
                "alternative_time": "10:00-11:00",
                "reason": "晚饭后的放松时段，用户有充足时间互动"
            }
        }
        date_type = "周末"
    else:
        # 工作日推荐
        recommendations = {
            "实用干货": {
                "best_time": "12:00-13:30",
                "alternative_time": "18:00-20:00",
                "reason": "午休时间，用户会利用碎片时间学习实用技巧"
            },
            "知识科普": {
                "best_time": "18:00-20:00",
                "alternative_time": "21:00-22:00",
                "reason": "晚高峰+晚饭后，适合深度内容阅读"
            },
            "治愈故事": {
                "best_time": "21:00-22:00",
                "alternative_time": "7:00-9:00",
                "reason": "睡前阅读时段，用户更容易产生情感共鸣"
            }
        }
        date_type = "工作日"

    # 根据内容类型选择推荐
    rec = recommendations.get(content_type, recommendations["实用干货"])

    return {
        "date_type": date_type,
        "best_time": rec["best_time"],
        "alternative_time": rec["alternative_time"],
        "reason": rec["reason"]
    }
```

**内容类型判断规则**：
- **实用干货**：教程、方法、技巧、避坑类
- **知识科普**：原理、对比、科普类
- **治愈故事**：心情、感悟、治愈类

**输出位置**：
- 写入`生成结果.md`文档的"发布建议"部分
- 包含：日期类型、最佳时间、次选时间、推荐理由

---

## 📄 Markdown输出模板

### 订阅号模板
```markdown
<!-- 星标引导 -->
![星标引导](star_guide.png)

# 【标题，≤25字】

> 摘要，≤25字

---

## 引言
[开篇吸引读者，1-2句话，带出问题或共鸣] 🌿

![配图1](01.png)

## 一、[核心知识点A] 🪴
[干货内容，结构化呈现]

✅ **要点1**：[具体说明]
✅ **要点2**：[具体说明]

![配图2](02.png)

## 二、[核心知识点B] ☀️
[实操方法或案例]

⚠️ **注意**：[常见误区或提醒]

![配图3](03.png)

## 三、总结 💕

[一句话总结核心观点]

---

<!-- CTA区块 - 由内置推送功能自动插入，不要在此处写 CTA 内容 -->
<!-- 推送时会根据平台类型（订阅号/服务号）自动生成对应的 CTA -->

---

感谢阅读！如果这篇文章对你有帮助，欢迎：
🔖 收藏本文 - 随时查阅，实践时更方便
💬 留言交流 - 分享你的养植经验，我们一起成长
```

> ⚠️ **重要提示：CTA 统一由内置推送功能处理**
> 
> 文案中**不要**包含完整的 CTA 内容（如二维码、商品卡片等），只需保留结尾的互动引导文字。
> wechat-publish 会根据平台类型自动插入对应的 CTA：
> - 订阅号：企业微信二维码 + 订阅引导
> - 服务号：商品推荐卡片

### 服务号模板
```markdown
<!-- 星标引导 -->
![星标引导](star_guide.png)

# 【标题，≤25字】

> 摘要，≤25字

---

## 引言
[开篇，自然过渡到产品需求] 🌿

![配图1](01.png)

## [核心知识/使用场景]
[与商品相关的知识内容]

![配图2](02.png)

## [实际案例/效果展示]
[产品使用前后对比或效果]

---

<!-- CTA区块 - 由 wechat-publish 自动插入 -->
<!-- 服务号推送时会自动生成商品推荐卡片 -->

---

💬 **你有什么问题？** 欢迎评论区留言！

感谢阅读！如果这篇文章对你有帮助，欢迎：
🔖 收藏本文 - 随时查阅
💬 留言交流 - 分享你的经验
```

---

## ✅ Good Case（正确示例）

**用户输入：**
```
帮我生成一篇订阅号推文，选题是：春季阳台种植
```

**正确执行：**
1. ✅ 判断平台：订阅号
2. ✅ 搜索知识库：匹配 `阳台春季种植规划与实操全书.md`
3. ✅ 生成文案：标题15字 + 摘要20字 + 正文1200字
4. ✅ 判断选题类型：季节类 → 选择 soft-botanical 风格
5. ✅ 生成4张配图，全部使用 soft-botanical 风格
6. ✅ 创建文件夹 `2026-01-13_春季阳台种植/`
7. ✅ 保存 Markdown + 配图
8. ✅ 推送至草稿箱，返回链接

---

## ❌ Anti-Patterns（禁止行为）

**禁止示例1：中途询问确认**
```
❌ "我已经生成了标题，需要我继续生成正文吗？"
❌ "找到了3篇相关知识文档，请问要使用哪一篇？"
```
→ 应自动选择最匹配的一篇继续执行

**禁止示例2：标题超过25字**
```
❌ "春季阳台种植完全指南：从选品到养护的10个关键步骤"（29字）
```
→ 应精简为 "春季阳台种植：10个关键步骤 🌱"（16字）

**禁止示例3：未使用统一配图风格**
```
❌ 封面用 dreamy-photo，正文配图用 cozy-sketch
```
→ 应统一使用一种风格

**禁止示例4：摘要超过25字**
```
❌ "春天到了，阳台种植正当时，本文分享10个新手必知的种植技巧"（31字）
```
→ 应精简为 "阳台种植10个必知技巧 🌿"（13字）

---

## 🛠️ 错误处理

| 场景 | 处理方式 |
|------|---------| 
| 选题模糊 | 自动细化为具体主题，不询问 |
| 本地知识无匹配 | 自动网络搜索，保存结果至干货库 |
| 标题/摘要超长 | 自动精简，保留核心关键词 |
| 图片生成失败 | 跳过失败的图，继续生成其他 |
| API 超时 | 重试1次后跳过并记录日志 |
| 草稿箱推送失败 | 保存本地文件，提示手动上传 |
---

## 📁 临时文件管理（v3.0 新增）

**规则：**
- ✅ 所有测试/临时文件必须保存到专属临时文件夹
- ✅ 临时文件夹路径：`[选题文件夹]/.tmp/`
- ✅ 任务完成后自动清理
- ❌ 禁止临时文件散落在工作目录中

**临时文件目录结构：**
```
/内容发布/发布记录/2026/订阅号/2026-01-14_选题名/
├── 2026-01-14_选题名.md    # 正式文案
├── cover.png                  # 封面图
├── 01.png ~ 03.png            # 正文配图
└── .tmp/
    ├── test_*.png              # 测试图片
    ├── draft_*.md              # 草稿文件
    └── html_preview_*.html     # HTML预览
```

---

## 📚 知识库引用

### 本地知识库
- [subscription-copywriting.md](knowledge/subscription-copywriting.md) - 订阅号文案创作指南
- [service-product-linking.md](knowledge/service-product-linking.md) - 服务号商品关联指南
- [wechat-operation-tips.md](knowledge/wechat-operation-tips.md) - 公众号运营技巧汇总
- [cta-templates.md](knowledge/cta-templates.md) - CTA模板库

### 跨 Skill 引用
- [image-prompt-guide.md](file:///Users/dj/Desktop/%E5%B0%8F%E9%9D%99%E7%9A%84skills/xiaohongshu-content-generator/knowledge/image-prompt-guide.md) - **配图 Prompt 模板库（来自小红书 Skill）**

---

## 🔗 相关 Skills

- `wechat-content-generator`: 完整的微信内容生成和发布解决方案
- `web-resource-search`: 网络资源搜索（知识补充）
- `knowledge-integration`: 知识整合（干货文档生成）

---

## 📝 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v3.9 | 2026-01-23 | **架构清理**：移除所有对独立 wechat-publish skill 的引用，确认功能已完全整合；**文档统一**：wechat-content-generator 现在是完整的微信内容生成和发布一体化解决方案 |
| v3.8 | 2026-01-23 | **推送前重复检查**：自动检测全文重复内容（段落、短语、CTA、标题）；**Markdown规范**：移除模板中的"感谢阅读"避免重复，规范图片位置；**内容深度优化**：区分简单vs进阶植物，增加配图数量至6张 |
| v3.7 | 2026-01-19 | 新增订阅号图文格式库（诗意金句治愈哲理、实用干货体、故事叙事体、问答互动体）|
| v3.6 | 2026-01-19 | **时间信息查询强制规则**：涉及时间点的内容必须先查询再写入，新增Step 0时间验证流程，包含节日、节气、倒计时等查询方法 |
| v3.5 | 2026-01-18 | **摘要生成强制规则**：必须为每篇文章生成≤25字摘要，包含核心价值、时效性和吸引力 |
| v3.4 | 2026-01-17 | **文件命名规范**：发布文档使用【发布】前缀；**图片中文化**：强制要求图片中所有文字使用中文 |
| v3.2 | 2026-01-15 | **推送验证机制**：草稿箱推送后增加结果验证步骤；版本号同步 |
| v3.1 | 2026-01-15 | **基于文案生成 Prompt**：每张配图的 Prompt 必须从对应段落内容提取；禁止 DALL-E；图片嵌入强制规则；元信息清洗扩展 |
| v3.0 | 2026-01-14 | **双号运营策略整合**：订阅号/服务号定位差异、内容互补策略、每月推送分配、临时文件管理 |
| v2.0 | 2026-01-14 | 商品库集成：智能匹配商品，输出商品关联机会 |
| v1.2 | 2026-01-13 | 配图 Prompt 改为直接引用小红书 `image-prompt-guide.md`，避免重复维护 |
| v1.1 | 2026-01-13 | 新增模块化执行模式（text-only/image-only/single-image/cta-only/publish-only）+ 文档格式清洗功能 |
| v1.0 | 2026-01-13 | 初始版本：订阅号/服务号内容生成 + 配图 + 草稿箱推送 |

