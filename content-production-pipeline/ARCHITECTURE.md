# 🏗️ 内容生产流水线 - 架构说明

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                   用户输入（关键词 + 参数）                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              content-production-pipeline (主控制器)           │
│                                                               │
│  • 解析参数                                                   │
│  • 初始化 TodoWrite                                          │
│  • 协调各个 Skill                                            │
│  • 错误处理和重试                                             │
│  • 生成执行报告                                               │
└─────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│  Phase 1: 选题发现 │                    │  Sub-agent (未来) │
│                  │                    │                  │
│  Skill tool      │                    │  • 资料搜索       │
│  ↓               │                    │  • 趋势分析       │
│  topic-discovery │                    │  • 质量评估       │
└──────────────────┘                    └──────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                      选题列表（10个）                          │
│  • 选题标题                                                   │
│  • 选题类型                                                   │
│  • 关键词                                                     │
│  • 商品关联                                                   │
└─────────────────────────────────────────────────────────────┘
        ↓
        ├─────────────────────┬─────────────────────┬──────────
        ↓                     ↓                     ↓
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│ Phase 2: 小红书   │  │ Phase 3: 公众号   │  │ Phase 4: 视频脚本 │
│                  │  │                  │  │                  │
│ Skill tool       │  │ Skill tool       │  │ Skill tool       │
│ ↓                │  │ ↓                │  │ ↓                │
│ xiaohongshu-     │  │ wechat-content-  │  │ video-script-    │
│ content-         │  │ generator        │  │ generator        │
│ generator        │  │                  │  │                  │
│                  │  │ (v1.1 集成)      │  │ (v1.2 集成)      │
│ • 批量处理       │  │ • 智能筛选       │  │ • 智能筛选       │
│ • 进度追踪       │  │ • 自动推送       │  │ • 分镜生成       │
│ • 错误恢复       │  │                  │  │                  │
└──────────────────┘  └──────────────────┘  └──────────────────┘
        ↓                     ↓                     ↓
┌─────────────────────────────────────────────────────────────┐
│                        输出文件                               │
│                                                               │
│  小红书/                                                      │
│  ├── 2026-01-14_选题1/                                       │
│  │   ├── 文案.md                                            │
│  │   └── 图片 × 6                                           │
│  └── ...                                                     │
│                                                               │
│  订阅号/                                                      │
│  ├── 2026-01-14_选题1/                                       │
│  │   ├── 文案.md                                            │
│  │   └── 图片 × 4                                           │
│  └── ...                                                     │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                      执行报告                                 │
│  • 成功/失败统计                                              │
│  • 执行时间                                                   │
│  • 错误详情                                                   │
│  • 文件路径                                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心组件

### 1. 主控制器（Pipeline Skill）

**职责：**
- 参数解析和验证
- 流程编排和控制
- Skill 之间的数据传递
- 进度追踪（TodoWrite）
- 错误处理和重试
- 执行报告生成

**技术实现：**
- 使用 Skill tool 调用其他 skill
- 使用 Read tool 读取中间结果
- 使用 Write tool 生成报告
- 使用 TodoWrite tool 追踪进度

---

### 2. 选题发现模块（topic-discovery）

**输入：**
- 行业关键词（如：家居绿植）

**输出：**
- 选题报告（Markdown 文件）
- 10个结构化选题数据

**数据结构：**
```python
{
    "topic_id": "001",
    "title": "客厅光线不好？这5种耐阴绿植最适合你",
    "type": "场景痛点",
    "keywords": ["客厅", "耐阴", "绿植"],
    "products": [...]
}
```

---

### 3. 小红书内容生成模块（xiaohongshu-content-generator）

**输入：**
- 选题标题
- 选题类型
- 商品关联

**输出：**
- 文案文件（Markdown）
- 封面图片（1张）
- 正文配图（5张）

**技术栈：**
- Midjourney API（场景图生成）
- Gemini API（文字叠加）
- PIL（图片处理）

---

### 4. 公众号内容生成模块（wechat-content-generator）

**输入：**
- 选题标题
- 知识干货文档
- 商品关联

**输出：**
- 文案文件（Markdown）
- 封面图片（1张）
- 正文配图（3张）
- 草稿箱推送

**特点：**
- 智能选题筛选（优先场景痛点类）
- 自动推送至草稿箱
- 支持订阅号/服务号双号运营

---

### 5. 视频脚本生成模块（video-script-generator）

**输入：**
- 选题标题
- 平台类型（小红书/视频号/快手/抖音）

**输出：**
- 分镜脚本
- 逐字稿
- 配图建议

**特点：**
- 智能选题筛选（优先教程类）
- 多平台适配
- 支持知识分享类和生活感悟类

---

## 数据流

### 1. 选题数据流

```
用户输入关键词
    ↓
topic-discovery skill
    ↓
选题报告（Markdown）
    ↓
Pipeline 解析
    ↓
选题列表（Python 对象）
    ↓
分发到各个平台模块
```

### 2. 内容生成数据流

```
选题数据
    ↓
xiaohongshu-content-generator
    ↓
├─ 文案生成（Gemini）
├─ 商品匹配（Excel 查询）
├─ 场景图生成（Midjourney）
└─ 文字叠加（Gemini + PIL）
    ↓
输出文件（MD + PNG）
```

---

## 执行模式说明

### 单一 LLM 串行执行（当前模式）

> **⚠️ 重要：Skills 是指令文档，不是异步任务系统！**

**当前实现：**
- LLM 直接按各 Skill 指令执行所有步骤
- 无需"调用"或"等待"其他 Skill
- 数据在内存中传递（选题列表 → 内容生成）
- 进度追踪和报告

**执行流程示意：**
```
用户输入：/content-production-pipeline 家居绿植

LLM 直接执行：
├── Phase 1: search_web 搜索热点 → 分析 → 生成选题报告
├── Phase 2: 遍历选题 → 生成文案 → 调用云雾API生成配图 → 保存
├── Phase 3: 筛选选题 → 生成公众号文案 → 配图 → 推送草稿箱
└── Phase 4: 筛选选题 → 生成分镜脚本 → 逐字稿 → 配图
```

**❌ 禁止的写法（这些 API 不存在）：**
```python
# 不要这样写！Claude Code 没有这些机制
Skill(skill="topic-discovery", args="家居绿植")  # ❌
Task Output topic-discovery  # ❌
Task(subagent_type="Explore", ...)  # ❌
```

---

## 错误处理架构

### 错误分类

```
┌─────────────────────────────────────────┐
│            错误类型                      │
├─────────────────────────────────────────┤
│  致命错误（终止流水线）                   │
│  • 选题发现失败                          │
│  • 商品库无法访问                        │
│  • 输出目录无法创建                      │
├─────────────────────────────────────────┤
│  非致命错误（记录并继续）                 │
│  • 单个内容生成失败                      │
│  • 图片生成失败                          │
│  • 推送草稿箱失败                        │
└─────────────────────────────────────────┘
```

### 重试机制

```
API 调用失败
    ↓
重试 1 (延迟 5秒)
    ↓ 失败
重试 2 (延迟 5秒)
    ↓ 失败
重试 3 (延迟 5秒)
    ↓ 失败
记录错误，继续下一个
```

---

## 性能优化策略

### 当前策略（v1.0）

**串行执行：**
- 选题按顺序处理
- 避免 API 限流
- 稳定可靠

### 未来优化（v1.1+）

**智能并发：**
```
选题1 → 小红书 ─┐
                ├─ 并发
选题1 → 公众号 ─┘

选题2 → 小红书 ─┐
                ├─ 并发
选题2 → 公众号 ─┘
```

**图片并发：**
```
封面图 ─┐
配图1  ├─ 并发生成
配图2  ├─ (同一选题内)
配图3  ┘
```

---

## 扩展性设计

### 添加新平台

**步骤：**
1. 创建新的 skill（如：douyin-content-generator）
2. 在 Pipeline 中添加 Phase
3. 更新选题筛选规则
4. 更新执行报告模板

**代码示例：**
```python
# 在 SKILL.md 中添加
### Phase 5: 抖音内容生成
Skill(skill="douyin-content-generator", args=topic.title)
```

### 添加新功能

**示例：内容质量评估**
```python
# 使用 Sub-agent 评估内容质量
Task(
    subagent_type="general-purpose",
    prompt="评估这篇内容的质量，给出改进建议",
    description="质量评估"
)
```

---

## 监控和日志

### 进度追踪（TodoWrite）

```
✅ 已完成：选题发现（10个选题）
🔄 进行中：小红书内容生成（3/10）
⏳ 待处理：公众号内容生成
⏳ 待处理：视频脚本生成
```

### 执行日志

```
[2026-01-14 15:30:00] 🏭 启动流水线
[2026-01-14 15:30:05] ✅ 选题发现完成
[2026-01-14 15:30:10] 🔄 开始处理选题1
[2026-01-14 15:35:20] ✅ 选题1完成
[2026-01-14 15:35:25] 🔄 开始处理选题2
...
```

### 执行报告

```markdown
# 内容生产流水线执行报告

**执行时间：** 2026-01-14 15:30:00
**总耗时：** 45分钟
**成功率：** 90%

## 统计
- 选题总数：10
- 成功：9
- 失败：1

## 详情
[详细的成功/失败列表]
```

---

## 总结

### 当前状态（v1.0）
- ✅ 基础架构完成
- ✅ 小红书单平台支持
- ✅ 批量处理和进度追踪
- ✅ 错误处理和报告

### 下一步（v1.1）
- ⏳ 集成公众号内容生成
- ⏳ 智能选题筛选
- ⏳ 性能优化

### 未来展望（v2.0）
- ⏳ 集成视频脚本生成
- ⏳ Sub-agent 集成
- ⏳ 内容质量评估
- ⏳ 智能优化建议
